<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana Snitch ğŸŒğŸµ</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg: #fff9c4; --card: #ffffff; --text: #333; --accent: #ffd700;
            --me-bubble: #fff176; --other-bubble: #ffffff; --border: #e0e0e0;
            --snitch: #ff3d00;
        }
        body.dark-mode {
            --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #ffee00;
            --me-bubble: #fbc02d; --other-bubble: #424242; --border: #444;
        }
        body { 
            font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text);
            text-align: center; padding: 0; margin: 0; transition: 0.3s;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 100 100"><text x="50%" y="50%" font-size="30" text-anchor="middle" dy=".3em" opacity="0.1">ğŸŒ</text></svg>');
        }
        
        .header { background: var(--card); padding: 5px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-bottom: 3px solid var(--accent); }
        h1 { margin: 5px; font-size: 1.4rem; color: #5d4037; cursor: pointer; }
        
        .streak-bar {
            background: linear-gradient(90deg, #ff9800, #ff5722);
            color: white; padding: 10px; margin: 10px auto; width: 90%; max-width: 600px;
            border-radius: 15px; box-shadow: 0 4px 15px rgba(255, 87, 34, 0.4);
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        .streak-count { font-size: 1.5rem; text-shadow: 1px 1px 2px black; }
        .streak-progress { font-size: 0.9rem; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 10px; }

        .container { background: var(--card); padding: 15px; max-width: 600px; margin: 10px auto; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        .avatar-selection { margin-bottom: 10px; display: flex; justify-content: center; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        .avatar-option { font-size: 1.6rem; cursor: pointer; padding: 5px; border-radius: 50%; opacity: 0.6; transition: 0.2s; }
        .avatar-option.selected { opacity: 1; background: rgba(255, 215, 0, 0.3); transform: scale(1.2); border: 2px solid var(--accent); }

        input[type="text"], textarea { 
            padding: 12px; border-radius: 20px; border: 2px solid #eee; width: 90%; 
            text-align: center; margin-bottom: 10px; background: #f9f9f9; color: var(--text); 
            font-family: inherit; font-size: 1rem;
        }
        body.dark-mode input[type="text"], body.dark-mode textarea { background: #333; border-color: #555; }
        
        .tabs { margin: 10px 0; display: flex; justify-content: center; gap: 10px; }
        button { border: none; padding: 8px 15px; font-weight: bold; cursor: pointer; border-radius: 20px; font-size: 0.9rem; transition: 0.2s; }
        .tab-btn { background: transparent; border: 2px solid var(--accent); color: var(--text); }
        .tab-btn.active { background: var(--accent); color: #3e2723; transform: scale(1.05); }
        
        .action-area { display: flex; flex-direction: column; gap: 5px; align-items: center; }
        .send-btn { background: #4caf50; color: white; border-radius: 50px; padding: 10px 40px; margin-top: 5px; font-size: 1rem; }
        
        .controls-row { display: flex; gap: 10px; margin-top: 10px; width: 100%; justify-content: center; align-items: center; }
        .bot-btn { background: #9c27b0; color: white; border-radius: 50px; font-size: 0.85rem; padding: 10px; flex: 1; }
        .teach-btn { background: #ff9800; color: white; border-radius: 50px; font-size: 0.85rem; padding: 10px; flex: 1; }
        
        /* ×›×¤×ª×•×¨ ×”××œ×©×™× ×•×Ÿ ×”×—×“×© - ×‘× × ×” ×¢× ××•×–×™×§×” */
        .snitch-btn { 
            background: #fff; border: 3px solid var(--snitch); color: black; 
            border-radius: 50%; font-size: 1.5rem; 
            width: 55px; height: 55px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: 0.2s;
            cursor: pointer;
        }
        .snitch-btn:active { transform: scale(0.9); background: var(--snitch); }
        body.dark-mode .snitch-btn { background: #333; border-color: #ff3d00; }

        .night-toggle { position: fixed; top: 15px; left: 15px; background: #333; color: white; z-index: 2000; font-size: 1rem; border-radius: 50px; padding: 5px 10px; }

        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; padding: 10px; max-width: 800px; margin: 0 auto; }
        .card-img { background: var(--card); border-radius: 15px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border: 1px solid var(--border); text-align: right; }
        .card-img img { width: 100%; height: 220px; object-fit: cover; }
        .card-info { padding: 12px; }
        .card-date { font-size: 0.75rem; color: #888; margin-top: 5px; display: block; }
        .card-actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .btn-small { background: #eee; color: #333; padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; flex: 1; }
        body.dark-mode .btn-small { background: #333; color: #fff; }

        .comments-section { display: none; background: rgba(0,0,0,0.03); padding: 10px; margin-top: 10px; border-radius: 10px; font-size: 0.9rem; }
        .comment-row { border-bottom: 1px solid var(--border); padding: 5px 0; }
        .comment-user { font-weight: bold; color: #ef6c00; }
        
        .chat-list { display: flex; flex-direction: column; gap: 8px; padding: 20px 10px; max-width: 600px; margin: 0 auto; padding-bottom: 80px; }
        .msg-row { display: flex; width: 100%; margin-bottom: 5px; }
        .msg-row.me { justify-content: flex-end; } .msg-row.other { justify-content: flex-start; } 
        .msg-bubble { max-width: 75%; padding: 10px 15px; border-radius: 15px; position: relative; font-size: 1rem; line-height: 1.4; box-shadow: 0 2px 4px rgba(0,0,0,0.1); word-wrap: break-word; text-align: right; }
        .msg-row.me .msg-bubble { background-color: var(--me-bubble); border-radius: 15px 0 15px 15px; border: 1px solid #fdd835; }
        .msg-row.other .msg-bubble { background-color: var(--other-bubble); border-radius: 0 15px 15px 15px; border: 1px solid #eee; }
        .msg-row.bot .msg-bubble { background-color: #f3e5f5; border: 2px solid #ab47bc; margin: 0 auto; text-align: center; }
        body.dark-mode .msg-row.bot .msg-bubble { background-color: #4a148c; border-color: #7b1fa2; }
        .sender-name { font-size: 0.75rem; font-weight: bold; color: #ef6c00; margin-bottom: 4px; }
        .timestamp { font-size: 0.65rem; color: #999; text-align: left; margin-top: 4px; display: block; }
        .like-btn { font-size: 0.8rem; background: none; border: none; cursor: pointer; color: #888; float: left; margin-right: 5px; }

        #overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:3000; justify-content:center; align-items:center; flex-direction:column; }
        #overlay img { max-width:95%; max-height:80%; border-radius: 10px; border: 2px solid white; }
        .close-btn { background: var(--accent); color: black; margin-top: 20px; padding: 10px 30px; border:none; border-radius:50px; font-weight:bold; cursor:pointer;}
        .hidden { display: none; }
        
        #snitch-alert { display:none; position: fixed; top:50%; left:50%; transform:translate(-50%, -50%); background: red; color:white; font-size: 2rem; padding: 20px; z-index: 5000; border-radius: 20px; box-shadow: 0 0 50px red; text-align: center; font-weight: bold; border: 5px solid white; }
    </style>
</head>
<body>

    <button class="night-toggle" onclick="toggleNight()">ğŸŒ™</button>

    <div id="overlay">
        <img id="fullImg" src="">
        <button class="close-btn" onclick="closeImg()">×¡×’×•×¨</button>
    </div>
    
    <div id="snitch-alert">ğŸš¨ ×–××‘×•×¨×”!!! ğŸš¨<br><span id="snitch-user" style="font-size:1rem;"></span></div>

    <div class="header">
        <h1 onclick="secretClick()">Nano Banana ğŸŒ</h1>
        
        <div id="streakBar" class="streak-bar">
            <div style="text-align:right;">
                <div style="font-size:0.8rem;">ğŸ”¥ ×¡×˜×¨×™×§ ×§×‘×•×¦×ª×™</div>
                <div id="streakDays" class="streak-count">0 ×™××™×</div>
            </div>
            <div class="streak-progress">
                <div id="streakStatus">0/3 ×—×‘×¨×™× ×œ×”×™×•×</div>
            </div>
        </div>

        <div class="tabs">
            <button id="btn-chat" onclick="switchTab('chat')" class="tab-btn active">ğŸ’¬ ×¦'××˜</button>
            <button id="btn-real" onclick="switchTab('real')" class="tab-btn">ğŸ“¸ ×’×œ×¨×™×”</button>
            <button id="btn-nano" onclick="switchTab('nano')" class="tab-btn">ğŸŒ × × ×•</button>
        </div>
    </div>

    <div class="container">
        <div id="avatar-selection" class="avatar-selection"></div>
        <input type="text" id="uploaderName" placeholder="×”×©× ×©×œ×š (×—×•×‘×”)" oninput="refreshChatView()">

        <div id="chat-input-area" class="action-area">
            <textarea id="chatInput" placeholder="×”×§×œ×“ ×”×•×“×¢×”..."></textarea>
            <button class="send-btn" onclick="sendChat()">×©×œ×™×—×” â¤</button>
            
            <div class="controls-row">
                <button class="bot-btn" onclick="triggerBot()">ğŸ¤– ×‘× × ×”-×‘×•×˜</button>
                <button class="teach-btn" onclick="teachBot()">ğŸ“ ×œ××“ ×‘×•×˜</button>
                <button class="snitch-btn" onclick="activateSnitch()">ğŸŒğŸµ</button>
            </div>
        </div>

        <div id="img-input-area" class="action-area hidden">
            <input type="text" id="descInput" placeholder="×ª×™××•×¨ ×œ×ª××•× ×”...">
            <button class="send-btn" onclick="checkUpload()">ğŸ“· ×‘×—×¨ ×ª××•× ×” ×œ×”×¢×œ××”</button>
            <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="uploadFile()">
        </div>
        
        <div id="status" style="color: orange; font-weight: bold; margin-top:5px;"></div>
    </div>

    <div id="content-area"></div>

    <script>
        // ==============================================================
        //  ğŸš¨ ×›××Ÿ ×”×§×¡×: ×©× ×”×§×•×‘×¥ ×”××œ× ×©××ª×” ××¢×œ×” ×œ-GitHub
        //  ×”×§×•×“ ×™×ª×—×™×œ ××“×§×” 1:03 ×•×™×¡×™×™× ×‘-1:35
        // ==============================================================
        const SNITCH_SOUND_URL = "song.mp3"; 
        
        const firebaseConfig = {
          apiKey: "AIzaSyBR9taEgDlp4CaFa1oDlA2wM9ENoZD2V9U",
          authDomain: "nano-banana-gallery-4e291.firebaseapp.com",
          projectId: "nano-banana-gallery-4e291",
          storageBucket: "nano-banana-gallery-4e291.firebasestorage.app",
          messagingSenderId: "843216131791",
          appId: "1:843216131791:web:e63ec1ab2f70b0808dc9ba"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const COLLECTION_NAME = "banana_v3"; 
        
        let currentTab = 'chat';
        let clicks = 0;
        let allData = []; 
        const avatars = ['ğŸŒ', 'ğŸ¦', 'ğŸ˜', 'ğŸ¤–', 'ğŸ‘½', 'ğŸ’©', 'ğŸ¤¡', 'ğŸ‘»', 'âš½', 'ğŸš¬'];
        let selectedAvatar = avatars[0];

        const baseRoasts = [
            "×”×˜×¡×˜×¨ ×©×œ×š ×‘×™×§×© ×ª×•×¡×¤×ª ×¡×™×›×•×Ÿ ×œ××©×›×•×¨×ª ××—×¨×™ ×”×˜×¡×˜ ××™×ª×š.",
            "×‘× ×•×ª ×œ× ××¡× × ×•×ª ××•×ª×š, ×”×Ÿ ×¤×©×•×˜ ×—×•×¡××•×ª ××ª ×”××¡×¤×¨ ××¨××©.",
            "×™×© ×œ×š ×¤×¨×•×¤×™×œ ×¦×‘××™ 97... ×‘×œ×”×™×•×ª × ×•×“× ×™×§.",
            "×”×™×“ ×§×“××™×ª ×©×œ×š × ×¨××™×ª ×›××• × ×§× ×™×§×™×™×”, ×•×”××—×•×¨×™×ª ×›××• ×¤×™×¨×”.",
            "××ª×” × ×¨××” ×›××• ××™×©×”×• ×©×™×•×¦×™× ×¤×˜×•×¨ ×–×§×Ÿ ×¢×œ '×›×™×¢×•×¨ ×™×ª×¨'.",
            "×”×¨×™×– ×©×œ×š ×‘××™× ×•×¡, ××ª×” ×—×™×™×‘ ×›×¨×™×–××” ×œ××¡ ×”×›× ×¡×”.",
            "××ª×” ×ª×”×™×” ×”× ×”×’ ×ª×•×¨×Ÿ ×œ× ×¦×—, ×›×™ ××£ ××—×“ ×œ× ×¡×•××š ×¢×œ×™×š ×¢× ×”××œ×›×•×”×•×œ.",
            "×”××•×— ×©×œ×š ×‘××¦×‘ ×˜×™×¡×” ×›×‘×¨ 18 ×©× ×”."
        ];

        function initAvatars() {
            const container = document.getElementById('avatar-selection');
            avatars.forEach(av => {
                const el = document.createElement('span');
                el.className = 'avatar-option';
                el.innerText = av;
                if(av === selectedAvatar) el.classList.add('selected');
                el.onclick = function() {
                    document.querySelectorAll('.avatar-option').forEach(e => e.classList.remove('selected'));
                    el.classList.add('selected');
                    selectedAvatar = av;
                }
                container.appendChild(el);
            });
        }
        initAvatars();

        function toggleNight() { document.body.classList.toggle('dark-mode'); }
        function secretClick() { clicks++; if(clicks===3){ if(prompt("×¡×™×¡××”:")==="1234") { document.body.classList.add('admin'); alert("××¦×‘ ×× ×”×œ!"); } clicks=0; } }

        function switchTab(t) { 
            currentTab = t;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(t === 'chat' ? 'btn-chat' : (t==='real'?'btn-real':'btn-nano')).classList.add('active');
            const chatArea = document.getElementById('chat-input-area');
            const imgArea = document.getElementById('img-input-area');
            if (t === 'chat') { chatArea.classList.remove('hidden'); imgArea.classList.add('hidden'); } 
            else { chatArea.classList.add('hidden'); imgArea.classList.remove('hidden'); }
            renderContent();
        }

        function activateSnitch() {
            const name = document.getElementById('uploaderName').value || "×× ×•× ×™××™";
            if(confirm("×œ×”×¤×¢×™×œ ××ª ×”××œ×©×™× ×•×Ÿ? ğŸŒğŸµ")) {
                db.collection('system').doc('snitch').set({
                    triggeredBy: name,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }

        db.collection('system').doc('snitch').onSnapshot(doc => {
            if (doc.exists) {
                const data = doc.data();
                if (data.timestamp) {
                    const now = new Date().getTime();
                    const triggerTime = data.timestamp.toMillis();
                    if (now - triggerTime < 10000) {
                        playAudio();
                        showSnitchAlert(data.triggeredBy);
                    }
                }
            }
        });

        // --- ×”×¤×•× ×§×¦×™×” ×”×—×“×©×” ×©×× ×’× ×ª ××“×§×” 1:03 ×¢×“ 1:35 ---
        function playAudio() {
            const audio = new Audio(SNITCH_SOUND_URL);
            
            // ×”×’×“×¨×ª ×–×× ×™× (×‘×©× ×™×•×ª)
            const startTime = 63; // ×“×§×” ×•×©×œ×•×© ×©× ×™×•×ª = 63 ×©× ×™×•×ª
            const endTime = 95;   // ×“×§×” ×•-35 ×©× ×™×•×ª = 95 ×©× ×™×•×ª

            // ××ª×—×™×œ ×œ× ×’×Ÿ ×¨×§ ××—×¨×™ ×©×”×§×•×‘×¥ × ×˜×¢×Ÿ
            audio.addEventListener('loadedmetadata', function() {
                this.currentTime = startTime;
            });

            audio.addEventListener('timeupdate', function() {
                if (this.currentTime >= endTime) {
                    this.pause();
                    this.currentTime = startTime; // ××—×–×™×¨ ×œ×”×ª×—×œ×” ×œ×¤×¢× ×”×‘××”
                }
            });

            audio.play().catch(e => {
                console.log(e);
                alert("×œ× ×”×¦×œ×—×ª×™ ×œ× ×’×Ÿ! ×•×•×“× ×©×§×¨××ª ×œ×§×•×‘×¥ song.mp3");
            });
        }

        function showSnitchAlert(name) {
            const el = document.getElementById('snitch-alert');
            document.getElementById('snitch-user').innerText = "×”×•×¤×¢×œ ×¢\"×™: " + name;
            el.style.display = 'block';
            confetti({ particleCount: 500, spread: 200, colors: ['#ff0000', '#ffffff'] });
            document.body.style.animation = "shake 0.5s infinite";
            setTimeout(() => { el.style.display = 'none'; document.body.style.animation = "none"; }, 3000);
        }

        function checkStreak() {
            const streakDocRef = db.collection('stats').doc('streak');
            streakDocRef.onSnapshot(doc => {
                const today = new Date().toDateString();
                let streakData = doc.exists ? doc.data() : { currentStreak: 0, lastDate: "", contributors: [] };
                if (streakData.lastDate && streakData.lastDate !== today) {
                    const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                    if (streakData.lastDate !== yesterday.toDateString()) {
                        if (streakData.currentStreak > 0) {
                            streakDocRef.update({ currentStreak: 0, contributors: [], lastDate: today });
                            streakData.currentStreak = 0; streakData.contributors = [];
                        }
                    } 
                }
                const count = streakData.contributors ? streakData.contributors.length : 0;
                let displayCount = count;
                if (streakData.lastDate !== today) displayCount = 0;
                document.getElementById('streakDays').innerText = `${streakData.currentStreak} ×™××™×`;
                document.getElementById('streakStatus').innerText = `${displayCount}/3 ×—×‘×¨×™× ×œ×”×™×•×`;
                if (displayCount >= 3) { document.getElementById('streakStatus').innerText = "âœ… ×”×•×©×œ× ×œ×”×™×•×!"; document.getElementById('streakBar').style.background = "linear-gradient(90deg, #4caf50, #8bc34a)"; }
                else { document.getElementById('streakBar').style.background = "linear-gradient(90deg, #ff9800, #ff5722)"; }
            });
        }
        checkStreak();

        function updateStreak(userName) {
            const streakDocRef = db.collection('stats').doc('streak');
            const today = new Date().toDateString();
            db.runTransaction(transaction => {
                return transaction.get(streakDocRef).then(doc => {
                    let data = doc.exists ? doc.data() : { currentStreak: 0, lastDate: "", contributors: [] };
                    if (data.lastDate !== today) {
                        const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                        if (data.lastDate !== yesterday.toDateString() && data.lastDate !== "") data.currentStreak = 0;
                        data.contributors = []; data.lastDate = today;
                    }
                    if (!data.contributors.includes(userName)) {
                        data.contributors.push(userName);
                        if (data.contributors.length === 3) { data.currentStreak++; confetti({ particleCount: 200, spread: 100 }); }
                    }
                    transaction.set(streakDocRef, data);
                });
            });
        }

        function teachBot() {
            const roast = prompt("×›×ª×•×‘ ×™×¨×™×“×” ×—×“×©×” ×¢×œ ××™×©×”×• ××”×—×‘×•×¨×”:");
            if (roast && roast.length > 3) {
                db.collection('roasts').add({ text: roast, addedBy: document.getElementById('uploaderName').value || 'Anonymous', date: new Date() }).then(() => { alert("×”×‘×•×˜ ×œ××“! ğŸ˜ˆ"); });
            }
        }

        async function triggerBot() {
            let customRoasts = [];
            try { const snapshot = await db.collection('roasts').get(); snapshot.forEach(doc => customRoasts.push(doc.data().text)); } catch (e) { }
            const fullRoastList = [...baseRoasts, ...customRoasts];
            const txt = fullRoastList[Math.floor(Math.random() * fullRoastList.length)];
            db.collection(COLLECTION_NAME).add({ type: 'chat', text: txt, user: 'BananaBot', avatar: 'ğŸ¤–', tab: 'chat', likes: 0, isBot: true, date: firebase.firestore.FieldValue.serverTimestamp() });
            confetti();
        }

        function renderContent() {
            const container = document.getElementById('content-area');
            const myName = document.getElementById('uploaderName').value.trim();

            if (currentTab === 'chat') {
                container.className = 'chat-list';
                container.innerHTML = '';
                let chatData = [...allData].reverse(); 
                chatData.forEach(d => {
                    if (d.type && d.type !== 'chat') return; 
                    if (!d.type && d.img) return;
                    if (d.type === 'chat') {
                        const isMe = d.user === myName;
                        const isBot = d.isBot;
                        let rowClass = 'other'; if (isBot) rowClass = 'bot'; else if (isMe) rowClass = 'me';
                        const bubble = document.createElement('div'); bubble.className = `msg-row ${rowClass}`;
                        let timeStr = d.date ? d.date.toDate().toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'}) : "";
                        let nameHtml = '';
                        if (!isMe && !isBot) nameHtml = `<div class="sender-name">${d.avatar||''} ${d.user}</div>`;
                        if (isBot) nameHtml = `<div class="sender-name">ğŸ¤– ×‘× × ×”-×‘×•×˜</div>`;
                        bubble.innerHTML = `<div class="msg-bubble">${nameHtml}<div>${d.text}</div><div style="margin-top:5px;"><button class="like-btn" onclick="addLike('${d.id}')">ğŸŒ ${d.likes||0}</button><span class="timestamp">${timeStr}</span></div></div>`;
                        container.appendChild(bubble);
                    }
                });
                setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);

            } else {
                container.className = 'gallery-grid';
                container.innerHTML = '';
                allData.forEach(d => {
                    const isImage = (d.type === 'image') || (!d.type && d.img);
                    if (!isImage || d.tab !== currentTab) return;
                    let timeStr = d.date ? d.date.toDate().toLocaleDateString('he-IL') + ' ' + d.date.toDate().toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'}) : "";
                    const card = document.createElement('div'); card.className = 'card-img';
                    card.innerHTML = `<img src="${d.img}" onclick="openImg('${d.img}')"><div class="card-info"><div style="font-weight:bold; font-size:1.1rem;">${d.avatar||''} ${d.user}</div><span class="card-date">${timeStr}</span>${d.desc ? `<div style="background:rgba(0,0,0,0.05); padding:5px; border-radius:5px; margin:5px 0;">${d.desc}</div>` : ''}<div class="card-actions"><button class="btn-small" onclick="addLike('${d.id}')">ğŸŒ ${d.likes||0}</button><button class="btn-small" id="btn-com-${d.id}" onclick="toggleComments('${d.id}')">ğŸ’¬ ×ª×’×•×‘×•×ª</button><button class="btn-small" onclick="addComment('${d.id}')">â• ×”×’×‘</button>${document.body.classList.contains('admin') ? `<button class="btn-small" style="background:#ffcdd2; color:red;" onclick="deletePost('${d.id}')">ğŸ—‘ï¸</button>` : ''}</div><div id="comments-${d.id}" class="comments-section">×˜×•×¢×Ÿ...</div></div>`;
                    container.appendChild(card);
                    loadComments(d.id);
                });
            }
        }

        function refreshChatView() { if (currentTab === 'chat') renderContent(); }
        function sendChat() {
            const name = document.getElementById('uploaderName').value;
            const text = document.getElementById('chatInput').value;
            if(!name) return alert("×›×ª×•×‘ ×©×!");
            if(!text) return;
            db.collection(COLLECTION_NAME).add({ type: 'chat', text: text, user: name, avatar: selectedAvatar, tab: 'chat', likes: 0, date: firebase.firestore.FieldValue.serverTimestamp() });
            document.getElementById('chatInput').value = "";
            confetti({ particleCount: 50, spread: 50, origin: { y: 0.8 } });
        }
        function checkUpload() { if(!document.getElementById('uploaderName').value) return alert("×›×ª×•×‘ ×©×!"); document.getElementById('fileInput').click(); }
        function uploadFile() {
            const file = document.getElementById('fileInput').files[0];
            const name = document.getElementById('uploaderName').value;
            const desc = document.getElementById('descInput').value;
            if(!file) return;
            document.getElementById('status').innerText = "××¢×œ×”...";
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const max = 800; let w=img.width, h=img.height;
                    if(w>h){if(w>max){h*=max/w;w=max}}else{if(h>max){w*=max/h;h=max}}
                    canvas.width=w; canvas.height=h; ctx.drawImage(img,0,0,w,h);
                    db.collection(COLLECTION_NAME).add({ type: 'image', img: canvas.toDataURL('image/jpeg', 0.6), user: name, avatar: selectedAvatar, desc: desc, tab: currentTab, likes: 0, date: firebase.firestore.FieldValue.serverTimestamp() }).then(() => { updateStreak(name); document.getElementById('status').innerText = ""; document.getElementById('descInput').value = ""; confetti(); });
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        function addLike(id) { db.collection(COLLECTION_NAME).doc(id).update({likes: firebase.firestore.FieldValue.increment(1)}); }
        function deletePost(id) { if(confirm("×œ××—×•×§?")) db.collection(COLLECTION_NAME).doc(id).delete(); }
        function openImg(u) { document.getElementById('fullImg').src=u; document.getElementById('overlay').style.display='flex'; }
        function closeImg() { document.getElementById('overlay').style.display='none'; }
        function toggleComments(id) { const el = document.getElementById('comments-' + id); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
        function addComment(id) { const name = prompt("××™ ××’×™×‘?"); if (!name) return; const text = prompt("××” ×”×ª×’×•×‘×”?"); if (!text) return; db.collection(COLLECTION_NAME).doc(id).collection("comments").add({ user: name, text: text, date: new Date() }); }
        function loadComments(id) { db.collection(COLLECTION_NAME).doc(id).collection("comments").orderBy("date", "asc").onSnapshot(snap => { const list = document.getElementById('comments-' + id); const btn = document.getElementById('btn-com-' + id); if(btn) btn.innerText = `ğŸ’¬ ×ª×’×•×‘×•×ª (${snap.size})`; if (snap.empty) { if(list) list.innerHTML = "××™×Ÿ ×ª×’×•×‘×•×ª."; } else { let html = ""; snap.forEach(doc => { const c = doc.data(); const dStr = c.date && c.date.toDate ? c.date.toDate().toLocaleString('he-IL') : ""; html += `<div class="comment-row"><span class="comment-user">${c.user}:</span> ${c.text}<br><span class="comment-time">${dStr}</span><div style="clear:both;"></div></div>`; }); if(list) list.innerHTML = html; } }); }
        db.collection(COLLECTION_NAME).orderBy("date", "desc").onSnapshot(snap => { allData = []; snap.forEach(doc => { let d = doc.data(); d.id = doc.id; allData.push(d); }); renderContent(); });
    </script>
</body>
</html>
